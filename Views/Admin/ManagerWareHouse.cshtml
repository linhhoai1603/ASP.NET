@{
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    ViewData["Title"] = "Manage Warehouses";
}
@model IEnumerable<ProjectDotNET.Models.Warehouse>;

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Manage Warehouses</h1>
</div>

<div class="table-responsive">
    <table class="table table-striped table-bordered mt-4">
        <thead class="table-dark">
            <tr>
                <th>Warehouse ID</th>
                <th>Warehouse Name</th>
                <th>Address</th>
                <th>Quantity</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @if (Model != null && Model.Any())
            {
                foreach (var warehouse in Model)
                {
                    <tr>
                        <td>@warehouse.WarehouseId</td>
                        <td>@warehouse.WarehouseName</td>
                        <td>@warehouse.Address</td>
                        <td>@(warehouse.Products?.Count() ?? 0)</td> <!-- Tránh null -->
                        <td>
                            <button class="btn btn-info btn-sm viewWarehouseButton" data-warehouse-id="@warehouse.WarehouseId" title="View">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-primary btn-sm editWarehouseButton" data-bs-toggle="modal" data-bs-target="#editWarehouseModal" data-warehouse-id="@warehouse.WarehouseId" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-danger btn-sm deleteWarehouseButton" data-bs-toggle="modal" data-bs-target="#deleteWarehouseModal" data-warehouse-id="@warehouse.WarehouseId" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="5" class="text-center">No warehouses found.</td>
                </tr>
            }
        </tbody>
    </table>
</div>

<div class="text-end mt-4">
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addWarehouseModal">Add New Warehouse</button>
</div>

<!-- Modal for Viewing a Warehouse -->
<div class="modal fade" id="viewWarehouseModal" tabindex="-1" aria-labelledby="viewWarehouseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewWarehouseModalLabel">View Warehouse</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <strong>Warehouse Name:</strong> <span id="viewWarehouseName"></span><br>
                <strong>Address:</strong> <span id="viewAddress"></span><br>
                <strong>Quantity:</strong> <span id="viewQuantity"></span><br>
                <strong>Product ID:</strong> <span id="viewProductId"></span><br>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Editing a Warehouse -->
<div class="modal fade" id="editWarehouseModal" tabindex="-1" aria-labelledby="editWarehouseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editWarehouseModalLabel">Edit Warehouse</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label for="warehouseName" class="form-label">Warehouse Name</label>
                        <input type="text" class="form-control" id="warehouseName">
                    </div>
                    <div class="mb-3">
                        <label for="address" class="form-label">Address</label>
                        <input type="text" class="form-control" id="address">
                    </div>
                    <div class="mb-3">
                        <label for="quantity" class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="quantity">
                    </div>
                    <div class="mb-3">
                        <label for="productId" class="form-label">Product ID</label>
                        <input type="number" class="form-control" id="productId">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveChangesButton">Save changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Deleting a Warehouse -->
<div class="modal fade" id="deleteWarehouseModal" tabindex="-1" aria-labelledby="deleteWarehouseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteWarehouseModalLabel">Delete Warehouse</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this warehouse?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="deleteWarehouseButton">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Adding a New Warehouse -->
<div class="modal fade" id="addWarehouseModal" tabindex="-1" aria-labelledby="addWarehouseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addWarehouseModalLabel">Add New Warehouse</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label for="newWarehouseName" class="form-label">Warehouse Name</label>
                        <input type="text" class="form-control" id="newWarehouseName">
                    </div>
                    <div class="mb-3">
                        <label for="newAddress" class="form-label">Address</label>
                        <input type="text" class="form-control" id="newAddress">
                    </div>
                    <div class="mb-3">
                        <label for="newQuantity" class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="newQuantity">
                    </div>
                    <div class="mb-3">
                        <label for="newProductId" class="form-label">Product ID</label>
                        <input type="number" class="form-control" id="newProductId">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="addWarehouseButton">Add Warehouse</button>
            </div>
        </div>
    </div>
</div>
<script>
           $('.viewWarehouseButton').click(function () {
        var warehouseId = $(this).data('warehouse-id');
        $.get('/Admin/ViewWarehouse/' + warehouseId, function (data) {
            if (data.success) {
                $('#viewWarehouseName').text(data.warehouse.WarehouseName);
                $('#viewAddress').text(data.warehouse.Address);
                $('#viewQuantity').text(data.warehouse.Products.length);
                var productIds = data.warehouse.Products.map(p => p.ProductId).join(", ");
                $('#viewProductId').text(productIds);
                $('#viewWarehouseModal').modal('show');
            } else {
                alert('Warehouse not found.');
            }
        }).fail(function () {
            alert('An error occurred while loading warehouse details.');
        });
    });


            $('.editWarehouseButton').click(function () {
        var warehouseId = $(this).data('warehouse-id');
        $.get('/Admin/ViewWarehouse/' + warehouseId, function (data) {
            if (data.success) {
                $('#warehouseName').val(data.warehouse.WarehouseName);
                $('#address').val(data.warehouse.Address);
                $('#quantity').val(data.warehouse.Products.length);
                $('#productId').val(data.warehouse.Products.map(p => p.ProductId).join(", "));
                $('#editWarehouseModal').data('warehouse-id', warehouseId);
                $('#editWarehouseModal').modal('show');
            } else {
                alert(data.message || 'Error loading warehouse details.');
            }
        }).fail(function () {
            alert('Failed to fetch warehouse details.');
        });
    });

       $('#saveChangesButton').click(function () {
        var warehouseId = $('#editWarehouseModal').data('warehouse-id');
        var updatedWarehouse = {
            WarehouseId: warehouseId,
            WarehouseName: $('#warehouseName').val(),
            Address: $('#address').val(),
            // Thực tế, Products có thể cần xử lý riêng để cập nhật
        };

        $.ajax({
            url: '/Admin/EditWarehouse',
            method: 'POST',
            data: updatedWarehouse,
            success: function (response) {
                if (response.success) {
                    alert('Warehouse updated successfully!');
                    location.reload(); // Làm mới trang
                } else {
                    alert(response.message || 'Failed to update warehouse.');
                }
            },
            error: function () {
                alert('An error occurred while saving changes.');
            }
        });
    });

    $('.deleteWarehouseButton').click(function() {
        var warehouseId = $(this).data('warehouse-id');
        $('#deleteWarehouseButton').data('warehouse-id', warehouseId);
    });

        $('.deleteWarehouseButton').click(function () {
        var warehouseId = $(this).data('warehouse-id');
        if (confirm('Are you sure you want to delete this warehouse?')) {
            $.ajax({
                url: '/Admin/DeleteWarehouse',
                method: 'POST',
                data: { warehouseId },
                success: function (response) {
                    if (response.success) {
                        alert('Warehouse deleted successfully!');
                        location.reload(); // Làm mới trang
                    } else {
                        alert(response.message || 'Failed to delete warehouse.');
                    }
                },
                error: function () {
                    alert('An error occurred while deleting the warehouse.');
                }
            });
        }
    });



</script>